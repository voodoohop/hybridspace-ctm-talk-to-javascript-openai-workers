<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRIO Display</title>
    <script src="auth.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: black;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        .carousel-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .carousel-image {
            max-width: 100vw;
            max-height: 100vh;
            object-fit: contain;
        }

        .qr-code {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 120px;
            background: white;
            padding: 5px;
            border-radius: 8px;
        }

        .qr-code img {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="carousel-container">
        <img id="carouselImage" class="carousel-image" style="display: none;">
        <div id="qrCode" class="qr-code" style="display: none;">
            <img id="qrCodeImg">
        </div>
    </div>

    <script>
        let allImages = [];
        let currentIndex = 0;
        let autoplayInterval = null;
        let lastImageId = null;
        let currentMode = null; // Will be set based on first image age
        
        // Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const showLatestOnly = urlParams.get('latest') === 'true';
        const hybridMode = urlParams.get('latest_hybrid') === 'true';
        
        // 1.5 minutes in milliseconds
        const LATEST_TIMEOUT_MS = 90000;

        async function loadImages() {
            try {
                const response = await fetch('/api/gallery');
                const data = await response.json();
                
                if (data.success && data.images.length > 0) {
                    allImages = data.images;
                    
                    if (showLatestOnly) {
                        // Show only the latest image
                        const latestImage = allImages[0]; // Already sorted by date (newest first)
                        
                        // Only update if there's a new image
                        if (latestImage.id !== lastImageId) {
                            lastImageId = latestImage.id;
                            displayLatestImage(latestImage);
                        }
                    } else if (hybridMode) {
                        // Hybrid mode: latest if fresh, carousel if old
                        const latestImage = allImages[0];
                        const imageAge = Date.now() - new Date(latestImage.uploaded).getTime();
                        const shouldShowLatest = imageAge < LATEST_TIMEOUT_MS;
                        
                        if (shouldShowLatest) {
                            // Show latest mode
                            if (currentMode !== 'latest' || latestImage.id !== lastImageId) {
                                currentMode = 'latest';
                                stopAutoplay();
                                lastImageId = latestImage.id;
                                displayLatestImage(latestImage);
                                console.log(`Hybrid mode: Showing latest image (${Math.round(imageAge/1000)}s old)`);
                            }
                        } else {
                            // Show carousel mode
                            if (currentMode !== 'carousel') {
                                currentMode = 'carousel';
                                shuffleArray(allImages);
                                currentIndex = 0;
                                displayCurrentImage();
                                startAutoplay();
                                console.log(`Hybrid mode: Switching to carousel (image ${Math.round(imageAge/1000)}s old)`);
                            }
                        }
                    } else {
                        // Original carousel behavior
                        shuffleArray(allImages);
                        currentIndex = 0;
                        displayCurrentImage();
                        if (!autoplayInterval) {
                            startAutoplay();
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading images:', error);
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function displayLatestImage(image) {
            const carouselImage = document.getElementById('carouselImage');
            const qrCode = document.getElementById('qrCode');
            const qrCodeImg = document.getElementById('qrCodeImg');

            // Set image
            carouselImage.src = image.url;
            carouselImage.style.display = 'block';

            // Set QR code
            qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(image.url)}`;
            qrCode.style.display = 'block';
            
            console.log('Displaying latest image:', image.id);
        }

        function displayCurrentImage() {
            if (allImages.length === 0) return;

            const image = allImages[currentIndex];
            const carouselImage = document.getElementById('carouselImage');
            const qrCode = document.getElementById('qrCode');
            const qrCodeImg = document.getElementById('qrCodeImg');

            // Set image
            carouselImage.src = image.url;
            carouselImage.style.display = 'block';

            // Set QR code
            qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(image.url)}`;
            qrCode.style.display = 'block';
        }

        function nextImage() {
            if (allImages.length === 0) return;
            
            currentIndex = Math.floor(Math.random() * allImages.length);
            displayCurrentImage();
        }

        function startAutoplay() {
            autoplayInterval = setInterval(nextImage, 15000); // Switch every 15 seconds
        }

        function stopAutoplay() {
            if (autoplayInterval) {
                clearInterval(autoplayInterval);
                autoplayInterval = null;
            }
        }

        // Load images on page load
        window.addEventListener('load', loadImages);

        // Reload images - adjust polling based on mode
        let pollInterval;
        if (showLatestOnly) {
            pollInterval = 5000; // 5 seconds for latest-only mode
        } else if (hybridMode) {
            pollInterval = 10000; // 10 seconds for hybrid mode (needs frequent checks)
        } else {
            pollInterval = 30000; // 30 seconds for carousel mode
        }
        
        setInterval(loadImages, pollInterval);
        
        let modeDescription;
        if (showLatestOnly) {
            modeDescription = 'Latest only';
        } else if (hybridMode) {
            modeDescription = 'Hybrid (latest â†’ carousel after 90s)';
        } else {
            modeDescription = 'Full carousel';
        }
        
        console.log(`Carousel mode: ${modeDescription}, polling every ${pollInterval/1000}s`);
    </script>
</body>
</html>
